{
  "version": 3,
  "sources": ["../../../src/wallet/index.ts"],
  "sourcesContent": ["// Copyright (c) Mysten Labs, Inc.\n// SPDX-License-Identifier: Apache-2.0\n\nimport { bcs } from '@mysten/sui.js/bcs';\nimport { toB64 } from '@mysten/sui.js/utils';\nimport type {\n\tStandardConnectFeature,\n\tStandardConnectMethod,\n\tStandardDisconnectFeature,\n\tStandardDisconnectMethod,\n\tStandardEventsFeature,\n\tStandardEventsListeners,\n\tStandardEventsOnMethod,\n\tSuiSignPersonalMessageFeature,\n\tSuiSignPersonalMessageMethod,\n\tSuiSignTransactionBlockFeature,\n\tSuiSignTransactionBlockMethod,\n\tWallet,\n} from '@mysten/wallet-standard';\nimport { getWallets, ReadonlyWalletAccount, SUI_MAINNET_CHAIN } from '@mysten/wallet-standard';\nimport type { Emitter } from 'mitt';\nimport mitt from 'mitt';\n\nimport { DEFAULT_STASHED_ORIGIN, StashedPopup } from './channel/index.js';\n\ntype WalletEventsMap = {\n\t[E in keyof StandardEventsListeners]: Parameters<StandardEventsListeners[E]>[0];\n};\n\nconst STASHED_RECENT_ADDRESS_KEY = 'stashed:recentAddress';\n\nexport const STASHED_WALLET_NAME = 'Stashed' as const;\n\nexport class StashedWallet implements Wallet {\n\t#events: Emitter<WalletEventsMap>;\n\t#accounts: ReadonlyWalletAccount[];\n\t#origin: string;\n\t#name: string;\n\n\tget name() {\n\t\treturn STASHED_WALLET_NAME;\n\t}\n\n\tget icon() {\n\t\treturn 'data:image/svg+xml;base64,PHN2ZyBmaWxsPSJub25lIiBoZWlnaHQ9IjMyIiB2aWV3Qm94PSIwIDAgMzIgMzIiIHdpZHRoPSIzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PGNsaXBQYXRoIGlkPSJhIj48cmVjdCBoZWlnaHQ9IjMyIiByeD0iMiIgd2lkdGg9IjMyIi8+PC9jbGlwUGF0aD48ZyBjbGlwLXBhdGg9InVybCgjYSkiPjxyZWN0IGZpbGw9IiNmZmYiIGhlaWdodD0iMzIiIHJ4PSIyIiB3aWR0aD0iMzIiLz48cGF0aCBkPSJtMCAwaDMydjMyaC0zMnoiIGZpbGw9IiNkNDA1NTEiLz48cGF0aCBkPSJtNS42NjgyNSAyNS4yNDkxYy0uNzgyNjMtLjc4MjctLjc4MDgxLTIuMDUyMS4wMDQwNi0yLjgzMjVsMTYuNjA1MjktMTYuNTEwNDdjLjc4MTctLjc3NzIzIDIuMDQ0OS0uNzc1NDMgMi44MjQzLjAwNDA0bC44Mzg3LjgzODYyYy43ODI1Ljc4MjUxLjc4MDggMi4wNTE3NC0uMDAzOCAyLjgzMjE4bC0xNi42MDE4OCAxNi41MTM4M2MtLjc4MTY1Ljc3NzUtMi4wNDUwOC43NzU4LTIuODI0NjYtLjAwMzd6bTUuNDQzMzUtMTUuOTExNjZjLTEuODA5NzIuMDUzNjctMi43NTM3MS0yLjEzMzA5LTEuNDczNDctMy40MTMzM2wuODM4MzctLjgzODMyYy4zNzUtLjM3NTA4Ljg4MzctLjU4NTc5IDEuNDE0Mi0uNTg1NzloMTMuNDc5N2MxLjEwNDYgMCAyIC44OTU0MyAyIDJ2MTMuNDc5N2MwIC41MzA1LS4yMTA3IDEuMDM5Mi0uNTg1OCAxLjQxNDJsLS44MjY5LjgyN2MtMS4yODE4IDEuMjgxOC0zLjQ3MDkuMzMzOS0zLjQxMzItMS40Nzc5bC4zMDY2LTkuNjI5OWMuMDM2Ny0xLjE1MjI3LS45MDU5LTIuMDk2OS0yLjA1ODMtMi4wNjI3M3oiIGZpbGw9IiNmZmYiLz48L2c+PC9zdmc+' as const;\n\t}\n\n\tget version() {\n\t\treturn '1.0.0' as const;\n\t}\n\n\tget chains() {\n\t\treturn [SUI_MAINNET_CHAIN] as const;\n\t}\n\n\tget accounts() {\n\t\treturn this.#accounts;\n\t}\n\n\tget features(): StandardConnectFeature &\n\t\tStandardDisconnectFeature &\n\t\tStandardEventsFeature &\n\t\tSuiSignTransactionBlockFeature &\n\t\tSuiSignPersonalMessageFeature {\n\t\treturn {\n\t\t\t'standard:connect': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\tconnect: this.#connect,\n\t\t\t},\n\t\t\t'standard:disconnect': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\tdisconnect: this.#disconnect,\n\t\t\t},\n\t\t\t'standard:events': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\ton: this.#on,\n\t\t\t},\n\t\t\t'sui:signTransactionBlock': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\tsignTransactionBlock: this.#signTransactionBlock,\n\t\t\t},\n\t\t\t'sui:signPersonalMessage': {\n\t\t\t\tversion: '1.0.0',\n\t\t\t\tsignPersonalMessage: this.#signPersonalMessage,\n\t\t\t},\n\t\t};\n\t}\n\n\tconstructor({\n\t\tname,\n\t\taddress,\n\t\torigin = DEFAULT_STASHED_ORIGIN,\n\t}: {\n\t\torigin?: string;\n\t\taddress?: string | null;\n\t\tname: string;\n\t}) {\n\t\tthis.#accounts = [];\n\t\tthis.#events = mitt();\n\t\tthis.#origin = origin;\n\t\tthis.#name = name;\n\n\t\tif (address) {\n\t\t\tthis.#setAccount(address);\n\t\t}\n\t}\n\n\t#signTransactionBlock: SuiSignTransactionBlockMethod = async ({ transactionBlock, account }) => {\n\t\ttransactionBlock.setSenderIfNotSet(account.address);\n\n\t\tconst data = transactionBlock.serialize();\n\n\t\tconst popup = new StashedPopup({ name: this.#name, origin: this.#origin });\n\t\tconst response = await popup.createRequest({\n\t\t\ttype: 'sign-transaction-block',\n\t\t\tdata,\n\t\t\taddress: account.address,\n\t\t});\n\n\t\treturn {\n\t\t\ttransactionBlockBytes: response.bytes,\n\t\t\tsignature: response.signature,\n\t\t};\n\t};\n\n\t#signPersonalMessage: SuiSignPersonalMessageMethod = async ({ message, account }) => {\n\t\tconst bytes = toB64(bcs.vector(bcs.u8()).serialize(message).toBytes());\n\t\tconst popup = new StashedPopup({ name: this.#name, origin: this.#origin });\n\t\tconst response = await popup.createRequest({\n\t\t\ttype: 'sign-personal-message',\n\t\t\tbytes,\n\t\t\taddress: account.address,\n\t\t});\n\n\t\treturn {\n\t\t\tbytes,\n\t\t\tsignature: response.signature,\n\t\t};\n\t};\n\n\t#on: StandardEventsOnMethod = (event, listener) => {\n\t\tthis.#events.on(event, listener);\n\t\treturn () => this.#events.off(event, listener);\n\t};\n\n\t#setAccount(address?: string) {\n\t\tif (address) {\n\t\t\tthis.#accounts = [\n\t\t\t\tnew ReadonlyWalletAccount({\n\t\t\t\t\taddress,\n\t\t\t\t\tchains: [SUI_MAINNET_CHAIN],\n\t\t\t\t\tfeatures: ['sui:signTransactionBlock', 'sui:signPersonalMessage'],\n\t\t\t\t\t// NOTE: Stashed doesn't support getting public keys, and zkLogin accounts don't have meaningful public keys anyway\n\t\t\t\t\tpublicKey: new Uint8Array(),\n\t\t\t\t}),\n\t\t\t];\n\n\t\t\tlocalStorage.setItem(STASHED_RECENT_ADDRESS_KEY, address);\n\t\t} else {\n\t\t\tthis.#accounts = [];\n\t\t}\n\n\t\tthis.#events.emit('change', { accounts: this.accounts });\n\t}\n\n\t#connect: StandardConnectMethod = async (input) => {\n\t\tif (input?.silent) {\n\t\t\tconst address = localStorage.getItem(STASHED_RECENT_ADDRESS_KEY);\n\n\t\t\tif (address) {\n\t\t\t\tthis.#setAccount(address);\n\t\t\t}\n\n\t\t\treturn { accounts: this.accounts };\n\t\t}\n\n\t\tconst popup = new StashedPopup({ name: this.#name, origin: this.#origin });\n\t\tconst response = await popup.createRequest({\n\t\t\ttype: 'connect',\n\t\t});\n\t\tif (!('address' in response)) {\n\t\t\tthrow new Error('Unexpected response');\n\t\t}\n\n\t\tthis.#setAccount(response.address);\n\n\t\treturn { accounts: this.accounts };\n\t};\n\n\t#disconnect: StandardDisconnectMethod = async () => {\n\t\tlocalStorage.removeItem(STASHED_RECENT_ADDRESS_KEY);\n\t\tthis.#setAccount();\n\t};\n}\n\nexport function registerStashedWallet(\n\tname: string,\n\t{\n\t\torigin,\n\t}: {\n\t\torigin?: string;\n\t},\n) {\n\tconst wallets = getWallets();\n\n\tlet addressFromRedirect: string | null = null;\n\ttry {\n\t\tconst params = new URLSearchParams(window.location.search);\n\t\taddressFromRedirect = params.get('stashed_address') || params.get('zksend_address');\n\t} catch {\n\t\t// Ignore errors\n\t}\n\n\tconst wallet = new StashedWallet({\n\t\tname,\n\t\torigin,\n\t\taddress: addressFromRedirect,\n\t});\n\n\tconst unregister = wallets.register(wallet);\n\n\treturn {\n\t\twallet,\n\t\tunregister,\n\t\taddressFromRedirect,\n\t};\n}\n"],
  "mappings": "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",
  "names": []
}
